# 多人游戏退出机制说明

## 功能概述

为微信小游戏添加了完整的多人游戏退出机制，确保房主和伙伴在绘画过程中能够优雅地退出，并同步更新数据库状态。

## 实现流程

### 1. 房主退出流程

1. **触发退出**：房主在绘画过程中点击返回按钮
2. **确认提示**：弹出确认对话框，提示"当前正在多人游戏，退出后房间将会释放"
3. **更新状态**：房主确认后，更新数据库中homeowner记录的operationType为"exit"
4. **返回主界面**：房主直接返回主界面

### 1.5. 伙伴主动退出流程

1. **触发退出**：伙伴在绘画过程中点击返回按钮
2. **确认提示**：弹出确认对话框，提示"当前正在多人游戏，退出后房间将会释放"
3. **更新状态**：伙伴确认后，更新数据库中teamworker记录的operationType为"exit"
4. **返回主界面**：伙伴直接返回主界面
5. **通知房主**：房主检测到伙伴退出后删除房间数据

### 2. 伙伴检测退出流程（被房主退出时）

1. **实时监听**：伙伴通过协作管理器实时监听房主数据变化
2. **检测退出**：当检测到房主数据中operationType为"exit"时，触发伙伴退出流程
3. **显示提示**：伙伴侧显示"房间已释放，返回主界面"的Toast提示
4. **倒计时**：开始3秒倒计时，每秒更新提示中的倒计时数字
5. **自动返回**：倒计时结束后自动返回主界面，无需用户操作

### 3. 房主检测伙伴退出流程

1. **实时监听**：房主通过协作管理器实时监听伙伴数据变化
2. **检测退出**：当检测到伙伴数据中operationType为"exit"时，触发数据清理流程
3. **数据清理**：房主删除数据库中的所有相关数据

### 4. 数据清理机制

1. **触发条件**：
   - 房主主动退出时删除房间数据
   - 房主检测到伙伴退出时删除房间数据
2. **删除范围**：根据房间号删除drawing集合中的所有相关记录
3. **停止监听**：停止所有数据库监听和轮询
4. **状态重置**：重置协作模式和界面状态

## 代码修改

### 1. teamTouchHandler.js

- 添加了`handleExitCollaborativePainting()`方法，根据角色处理不同退出流程
- 添加了`showExitConfirmationDialog()`方法，显示房主退出确认对话框
- 添加了`showTeamworkerExitConfirmationDialog()`方法，显示伙伴退出确认对话框
- 添加了`homeownerExitRoom()`方法，处理房主退出并更新数据库状态
- 添加了`teamworkerExitRoom()`方法，处理伙伴主动退出并更新数据库状态
- 添加了`handleHomeownerExit()`方法，处理伙伴检测到房主退出的情况
- 添加了`showExitCountdownDialog()`和`startExitCountdown()`方法，实现伙伴侧倒计时
- 添加了`deleteRoomData()`方法，删除房间相关数据

### 2. collaborationManager.js

- 修改了`handleOperationType()`方法，添加对"exit"操作类型的处理
- 优化了`handleHomeownerData()`方法，优先检查operationType，特别是exit操作
- 修改了`handleTeamworkerData()`方法，优先检查operationType，特别是exit操作
- 添加了`handleTeamworkerOperationType()`方法中对"exit"操作类型的处理，使房主能检测到伙伴退出

### 3. databaseManager.js

- 添加了`deleteRoomData()`方法，根据房间号删除所有相关数据

## 使用说明

### 房主操作

1. 在绘画过程中点击左上角返回按钮
2. 在弹出对话框中选择"确定退出"
3. 系统自动更新数据库状态并返回主界面

### 伙伴操作（被动退出）

1. 系统自动检测到房主退出操作
2. 显示提示和3秒倒计时
3. 倒计时结束后自动返回主界面

### 伙伴操作（主动退出）

1. 在绘画过程中点击左上角返回按钮
2. 在弹出对话框中选择"确定退出"
3. 系统自动更新数据库状态并返回主界面
4. 房主检测到伙伴退出后删除房间数据

## 技术细节

### 数据同步机制

- 使用微信云数据库的watch功能实时监听数据变化
- 对于watch功能失败的情况，使用轮询作为备选方案
- 房主和伙伴都通过协作管理器同步状态

### 错误处理

- 所有数据库操作都添加了错误处理
- 倒计时可以被中断和重置
- 退出流程在任何步骤出错都会保持界面一致性

### 兼容性

- 保持了原有代码结构和风格
- 不影响原有功能的正常运行
- 与现有协作系统无缝集成

## 测试建议

1. 测试房主在绘画未开始、绘画中和绘画完成后的退出流程
2. 测试伙伴在不同阶段检测到房主退出的情况
3. 测试网络异常情况下的退出流程
4. 测试同时有多人尝试加入同一房间的情况
5. 测试房主退出后伙伴快速重新创建房间的情况